{% extends "app/layout.html" %}
{% load staticfiles %}

{% block content %}
<div class="about-screen about-screen_korz">
    <div class="about-title">{{ title }}</div>
    <div class="about-title_descr">{{ message }}</div>
</div>
<div class="about-content about-content_korz">
    <div class="korz-table">
        <div class="korz-preload">Ваша корзина пуста</div>
    <!--<div class="row head"></div>
        <div class="rows"></div>
    <div class="itog"></div>-->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

    function get_korzina() {
        $(".korz-preload").delay(500).fadeIn();
        K = JSON.parse(localStorage.getItem("korzina"));
        if (K != null) {
            var c = K.l.length;
            var t = "";
            if (c > 0) {
                for (var i = 0; i < c; i++) {
                    //    t = t + `<div class="row" data-id="${K.l[i].id}" data-article="${K.l[i].article}">\
                    //    <div class="image"><img src="/media/${K.l[i].img}" alt="" /></div>\
                    //    <div class="name">${K.l[i].name} [${msg[i]}]</div>\
                    //    <div class="cost">${K.l[i].cost}</div>\
                    //    <div class="count">${K.l[i].count}</div>\
                    //    <div class="summ">${parseInt(K.l[i].cost) * parseInt(K.l[i].count)}</div>\
                    //    <div class="del" data-id="${i}" onclick="del(this)">X</div>\
                    //</div>`
                    //var ttt = [];
                    cts = [];
                    ids = [];
                    for (var i = 0; i < c; i++) {
                        ids.push(K.l[i].id);
                        cts.push(K.l[i].count);
                    }
                }
                var stroka = ids + '|' + cts
                var request = $.ajax({
                    url: "/korzinaget/",
                    method: "get",
                    //contentType: 'application/json; charset=utf-8',
                    data: { korzina: stroka },
                    dataType: 'text',
                });
            }
            //$(".rows").html(t)
        }

        request.done(function (msg) {
            $(".korz-table").html(msg);
            localStorage.removeItem("korzina");
            j = $("#kor").html();
            j = JSON.parse(j);
            localStorage.setItem("korzina", JSON.stringify(j));
            $("#kor").remove();
            ids = null;
            cts = null;
            $(".korz-preload").delay(500).fadeOut();
        });

        request.fail(function (jqXHR, textStatus) {
            alert("Request failed: " + textStatus);
            $(".korz-preload").delay(500).fadeOut();
        });
    }

    function del(e) {
        var id = e.getAttribute("data-id");
        var K = JSON.parse(localStorage.getItem("korzina"));
        //delete K.l[id];
        K.l.splice(parseInt(id), 1);
        localStorage.setItem("korzina", JSON.stringify(K));
        loadkorzina(false);
        e.parentElement.remove();
        get_korzina();
    }

    get_korzina();
</script>
{% endblock %}
